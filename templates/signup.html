<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Nanum+Myeongjo:wght@400;700;800&display=swap"
          rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <title>Sign Up</title>
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Jua&family=Nanum+Myeongjo:wght@400;700;800&display=swap"
          rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Jua&family=Nanum+Myeongjo:wght@400;700;800&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="../static/style.css">
</head>

<script>
    // 유효성 결과값 저장
    let c_id = 0
    let c_name = 0
    let c_mail = 0
    let c_pw = 0

    // 각 input value 수정 시에 유효성 결과값 초기화.
    function change_id() {
        c_id = 0
    }

    function change_username() {
        c_name = 0
    }

    function change_mail() {
        c_name = 0
    }


    // 회원가입 버튼 클릭 -> DB에 회원정보 저장
    function join() {
        if (c_id === 0) {
            alert("아이디를 확인을 해주세요.")
        } else if (c_name === 0) {
            alert("닉네임을 확인 해주세요.")
        } else if (c_mail === 0) {
            alert("이메일을 확인 해주세요.")
        } else if (c_pw === 0) {
            alert("비밀번호를 확인 해주세요.")
        } else {
            $.ajax({
                type: "POST",
                url: "/api/signup",
                data: {
                    id_give: $('#floatingId').val(),
                    name_give: $('#floatingUsername').val(),
                    mail_give: $('#floatingMail').val(),
                    pw_give: $('#floatingPassword').val()
                },
                success: function (response) {
                    if (response['result'] === 'success') {
                        alert('회원가입이 완료되었습니다.')
                        window.location.href = '/#'
                    } else {
                        alert(response['msg'])
                    }
                }
            })
        }
    }

    // ID 유효성 검사
    function check_id() {
        let user_id = $("#floatingId").val()
        let pattern1 = /[0-9]/; // 숫자
        let pattern2 = /[a-zA-Z]/; // 문자

        if (user_id === '') {
            alert('아이디를 입력하세요.')
        } else if (user_id.length < 8 || user_id.length > 20
            || !pattern1.test(user_id) || !pattern2.test(user_id)) {
            alert('아이디는 8~20자리 이내의 영문과 숫자로 입력해주세요.')
            document.getElementById('floatingId').value = null;
        } else {
            $.ajax({
                type: "POST",
                url: "/api/checkid",
                data: {
                    id_give: user_id
                },
                success: function (response) {
                    if (response['status'] === 0) {
                        c_id = 1
                        alert('사용 가능한 아이디 입니다.')
                    } else {
                        alert('이미 존재하는 아이디 입니다.')
                        document.getElementById('floatingId').value = null;
                    }
                }
            })
        }
    }

    // 닉네임 유효성 검사
    function check_username() {
        let user_name = $("#floatingUsername").val()

        if (user_name === '') {
            alert('닉네임을 입력하세요.')
        } else if (user_name < 3 || user_name > 10) {
            alert('닉네임은 3~10자리 이내로 입력해주세요.')
        } else {
            $.ajax({
                type: "POST",
                url: "/api/checkname",
                data: {
                    name_give: user_name
                },
                success: function (response) {
                    if (response['status'] === 0) {
                        c_name = 1
                        alert('사용 가능한 닉네임 입니다.')
                    } else {
                        alert('이미 존재하는 닉네임 입니다.')
                        document.getElementById('floatingUsername').value = null;
                    }
                }
            })
        }
    }

    // 이메일 유효성 검사
    function check_mail() {
        let user_mail = $("#floatingMail").val()

        let pattern = /^([0-9a-zA-Z_\.-]+)@([0-9a-zA-Z_-]+)(\.[0-9a-zA-Z_-]+){1,2}$/;

        if($('#floatingMail').val() === '') {
            alert('이메일을 입력하세요.')
        } else if (!pattern.test(user_mail)) {
            alert('이메일 형식으로 입력해주세요.')
            document.getElementById('floatingMail').value = null;
        } else {
            $.ajax({
                type: "POST",
                url: "/api/checkmail",
                data: {
                    mail_give: user_mail
                },
                success: function (response) {
                    if (response['status'] === 0) {
                        c_mail = 1
                        alert('사용 가능한 이메일 입니다.')
                    } else {
                        alert('이미 존재하는 이메일 입니다.')
                        document.getElementById('floatingMail').value = null;
                    }
                }
            })
        }
    }

    // 비밀번호 유효성 검사
    function check_pw1() {
        let user_pw = $('#floatingPassword').val()
        let pattern1 = /[0-9]/
        let pattern2 = /[a-zA-Z]/

        if (user_pw.length < 8 || !pattern1.test(user_pw) || !pattern2.test(user_pw)) {
            alert('비밀번호는 8자리 이상 영문과 숫자로 입력해주세요.')
            document.getElementById("floatingPassword").value = null;
        } else {
            alert('사용가능한 비밀번호입니다.')
        }
    }

    // 비밀번호 확인. 비밀번호와 동일한지 검사
    function check_pw2() {
        let user_pw1 = $('#floatingPassword').val()
        let user_pw2 = $('#floatingCheckPassword').val()

        if (user_pw2 === '') {
            $('.msg').text("")
        } else if (user_pw1 !== user_pw2){
            c_pw = 0
            $('.msg').css('color', 'red');
            $('.msg').text("비밀번호가 일치하지 않습니다.")
        } else {
            c_pw = 1
            $('.msg').css('color', 'blue');
            $('.msg').text("비밀번호가 일치 합니다.")
        }
    }
</script>

<body>

    <div class="mypost">
        <h1 class="title">오늘 Do? 내일 Do!</h1>
        <div class="login01">
            <div class="sign">
                <div class="form-floating mb-3 check-area-1">
                    <input type="text" class="form-control" id="floatingId" placeholder="placeholder" onchange="change_id()">
                    <label for="floatingId">아이디</label>
                    <button type="button" class="btn btn-secondary" onclick="check_id()">중복확인</button>
                </div>
                <div class="form-floating mb-3 check-area-1">
                    <input type="text" class="form-control" id="floatingUsername" placeholder="placeholder" onchange="change_username()">
                    <label for="floatingUsername">닉네임</label>
                    <button type="button" class="btn btn-secondary" onclick="check_username()">중복확인</button>
                </div>
                <div class="form-floating mb-5 check-area-2">
                    <input type="email" class="form-control" id="floatingMail" placeholder="placeholder" onchange="change_mail()">
                    <label for="floatingMail">이메일</label>
                    <button type="button" class="btn btn-secondary" onclick="check_mail()">중복확인</button>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="floatingPassword" placeholder="placeholder" onchange="check_pw1()">
                    <label for="floatingPassword">비밀번호</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="floatingCheckPassword" placeholder="placeholder" oninput="check_pw2()">
                    <label for="floatingCheckPassword">비밀번호 확인</label>
                    <p style="float: right" class="msg"></p>
                </div>
            </div>
            <div class="login-check">
                    <button type="button" class="btn btn-dark btn-lg" onclick="join()">회원가입</button>
                    <a href="#" type="button" class="btn btn-outline-dark btn-lg">취소</a>
            </div>
        </div>
    </div>

</body>
</html>